<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" type="text/css" href="/webjars/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="webjars/jquery-ui/jquery-ui.min.css" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/nav.css}" />
    <script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="/webjars/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" th:src="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.js}"></script>
	<link rel="stylesheet" type="text/css" href="/webjars/datatables/1.10.19/css/jquery.dataTables.min.css" />
	<script type="text/javascript" th:src="@{/webjars/datatables/1.10.19/js/jquery.dataTables.min.js}"></script>
    <script type="text/javascript">
    $(function() {
		$.ajax({
			type: "GET",
			url: "header",
			dataType : "html"
		})
		.done(function(data){ 
			$('#headerDiv').html(data);
		})
		.fail(function(XMLHttpRequest, textStatus, errorThrown){
			alert(errorThrown);
		});
		
		var table = null;
		
		function updateVendors() {
			$.ajax({
				type: "GET",
				url: "testerVendors",
				dataType : "json"
			})
			.done(function(data){ 
				$('#testervendor').empty();
				var vendor = null;
				for (let o of data) {
					$('#testervendor').append($('<option>').html(o.vendorname).val(o.id));
					if (vendor == null) {
						vendor = o.id;
					}
				}
				if (table == null) {
					createTable();
				}
			})
			.fail(function(XMLHttpRequest, textStatus, errorThrown){
				alert(errorThrown);
			});					
		};
		
		$('#vendorButton').click(function() {
			$("#vendorDialog").dialog('open');
		});		
		
		updateVendors();
	
		var selectedData;
		
		function createTable() {
			if (table != null) {
				table.destroy();
				$('#table').remove();
			}
			$('#main').append('<table id="testersTable"></table>');
			
			table = $('#testersTable').DataTable({
				"sAjaxSource": 'testerListJson?vendor=' + $('#testervendor').val(),
				"sAjaxDataProp": "",
				"columnDefs": [
				            {
				                "targets": [ 0 ],
				                "visible": false,
				                "searchable": false
				            }
				        ],
				"aoColumns": [
					{ "sTitle": "ID", "mData": "id" },
					{ "sTitle": "Product Name", "mData": "name" },
					{ "sTitle": "Category", "mData": "categoryText" },
					{ "sTitle": "Edit", "mData": null, "sDefaultContent": '<button class="btn-edit">Edit</button>' },
					{ "sTitle": "Delete", "mData": null, "sDefaultContent": '<button class="btn-delete">Delete</button>' },
				]
			});	
			
			$('#testersTable tbody').on( 'click', 'button', function () {
				var cls = $(this).attr('class');
				selectedData = table.row( $(this).parents('tr') ).data();
				if (cls == 'btn-edit') {
					$(".testerCategory").each(function(i,e){
						$('#' + e.id).prop('checked', false);
					});
					for (var c of selectedData.category) {
						$('#categoryCheck' + c).prop('checked', true);
					}

					$("#configDialog").dialog('open');
				}
				else if ('btn-delete') {
				
				}
		    } );
		}
		
		$('#testervendor').change(function() {
			//table.ajax.reload();
			createTable();
			//$('#table').remove();
		});
		
		$("#vendorDialog").dialog({
			modal:true,
			autoOpen: false,
			title: "Vendor Name",
			width: 400,
			height: 200,
			buttons: {
				"OK": function() {
					var obj = new Object();
					obj.vendorname = $('#newTesterVendor').val();
					if (obj.vendorname == '') {
						return;
					}
					var json = JSON.stringify(obj);
					$.ajax({
						type: "POST",
						url: "/testerVendor",
						data: json,
						contentType: "application/json",
						dataType : "json"
					}).done(function(data){
						updateVendors();
					}).fail(function(XMLHttpRequest, status, e){
						alert(e);
					});										
					$(this).dialog("close");
				},
				"Cancel": function() {
					$(this).dialog("close");
				}
			}
		});	
		
		$("#configDialog").dialog({
			modal:true,
			autoOpen: false,
			title: "Config",
			width: 800,
			height: 400,
			buttons: {
				"OK": function() {							
					$(this).dialog("close");
					
					var obj = new Object();
					obj.id = selectedData.id;
					obj.category = [];
					$(".testerCategory").each(function(i,e){
						if ($('#' + e.id).prop('checked')) {
							obj.category.push(e.id.replace('categoryCheck', ''));
						}
					});
					var json = JSON.stringify(obj);
					$.ajax({
						type: "POST",
						url: "/testerJson",
						data: json,
						contentType: "application/json",
						dataType : "text"
					}).done(function(data){
						table.ajax.reload();
					}).fail(function(XMLHttpRequest, status, e){
						alert(e);
					});					
					
					//testerCategory
					
				},
				"Cancel": function() {
					$(this).dialog("close");
				}
			}
		});	

		$("#newTesterDialog").dialog({
			modal:true,
			autoOpen: false,
			title: "New Tester",
			width: 800,
			height: 400,
			buttons: {
				"OK": function() {							
					$(this).dialog("close");
					
					var obj = new Object();
					obj.name = $('#newTesterText').val();
					obj.vendorid = $('#testervendor').val();
					var json = JSON.stringify(obj);
					$.ajax({
						type: "POST",
						url: "/testerJson",
						data: json,
						contentType: "application/json",
						dataType : "text"
					}).done(function(data){
						createTable();
					}).fail(function(XMLHttpRequest, status, e){
						alert(e);
					});										
				},
				"Cancel": function() {
					$(this).dialog("close");
				}
			}
		});	
		$("#categoryEditDialog").dialog({
			modal:true,
			autoOpen: false,
			title: "Category Editor",
			width: 400,
			height: 500,
			buttons: {
				"OK": function() {							
					$(this).dialog("close");
				
					var obj = new Object();
					obj.name = $('#newTesterText').val();
					obj.vendorid = $('#testervendor').val();
					var json = JSON.stringify(obj);
					$.ajax({
						type: "POST",
						url: "/",
						data: json,
						contentType: "application/json",
						dataType : "text"
					}).done(function(data){
						createTable();
					}).fail(function(XMLHttpRequest, status, e){
						alert(e);
					});	

				},
				"Cancel": function() {
					$(this).dialog("close");
				}
			}
		});		

		$('#addNewTester').click(function(){
			$("#newTesterDialog").dialog('open');
		});
		
		var categoryTable = $('#categoryEidtTable').DataTable({
			"sAjaxSource": 'TesterCategoryEntityS',
			"sAjaxDataProp": "",
			"columnDefs": [
			            {
			                "targets": [ 0 ],
			                "visible": false,
			                "searchable": false
			            }
			        ],
			"aoColumns": [
				{ "sTitle": "ID", "mData": "id" },
				{ "sTitle": "Category", "mData": "category_name" },
				{ "sTitle": "Edit", "mData": null, "sDefaultContent": '<button class="btn-edit">Edit</button>' },
				{ "sTitle": "Delete", "mData": null, "sDefaultContent": '<button class="btn-delete">Delete</button>' },
			]
		});	
		$('#categoryEidtTable tbody').on( 'click', 'button', function () {
			var cls = $(this).attr('class');
			var selectedCategory = table.row( $(this).parents('tr') ).data();
			if (cls == 'btn-edit') {
			}
			else if ('btn-delete') {
			
			}
	    } );
		$('#editCategoryButton').click(function() {
			$("#categoryEditDialog").dialog('open');
		});
		
		$("#newCategoryDialog").dialog({
			modal:true,
			autoOpen: false,
			title: "Category Editor",
			width: 400,
			height: 200,
			buttons: {
				"OK": function() {							
					$(this).dialog("close");
				
					var obj = new Object();
					obj.category_name = $('#newCategoryText').val();
					var json = JSON.stringify(obj);
					$.ajax({
						type: "POST",
						url: "/TesterCategoryEntity",
						data: json,
						contentType: "application/json",
						dataType : "json"
					}).done(function(data){
						categoryTable.ajax.reload();
					}).fail(function(XMLHttpRequest, status, e){
						alert(e);
					});	

				},
				"Cancel": function() {
					$(this).dialog("close");
				}
			}
		});	
		$('#addnewCategory').click(function(){
			$("#newCategoryDialog").dialog('open');
		});
    });
    </script>
</head>
<body>
	<div id='headerDiv'></div>
	<div>Manufacturer<select id='testervendor'></select><button id='vendorButton'>Add</button></div>
	<div id="vendorDialog">
		<input type="text" id="newTesterVendor"></input>	
	</div>
	<div id="configDialog">
		<div class="checkbox-inline" th:each="item : ${categoryCheckBox}">
		    <label>
		    	<input type="checkbox" class="testerCategory" name="selectedCategory" th:value="${item.key}" th:text="${item.value}" th:id="'categoryCheck' + ${item.key}"></input>
		    </label>
		</div>
	</div>
	
	<button id="addNewTester">Add New Product</button>
	<button id="editCategoryButton">Edit Category</button>
	<div id="newTesterDialog">
		Tester Name<input type="text" id="newTesterText"></input>
	</div>
	<div id="categoryEditDialog">
		<button id="addnewCategory">Add Category</button>
		<table id="categoryEidtTable"></table>
		<div id="newCategoryDialog">
			New Category<input type="text" id="newCategoryText">
		</div>
	</div>
	<div id="main"></div>
</body>
</html>
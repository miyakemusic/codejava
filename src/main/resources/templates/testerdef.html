<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" type="text/css" href="/webjars/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="webjars/jquery-ui/jquery-ui.min.css" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/nav.css}" />
    <script type="text/javascript" src="/webjars/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="/webjars/bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" th:src="@{/webjars/jquery-ui/1.12.1/jquery-ui.min.js}"></script>
	<link rel="stylesheet" type="text/css" href="/webjars/datatables/1.10.19/css/jquery.dataTables.min.css" />
	<link rel="stylesheet" type="text/css" href="/webjars/datatables-tabletools/2.2.4/css/dataTables.tableTools.css" />
	<script type="text/javascript" th:src="@{/webjars/datatables/1.10.19/js/jquery.dataTables.min.js}"></script>
	<script type="text/javascript" th:src="@{/webjars/datatables-tabletools/2.2.4/js/dataTables.tableTools.js}"></script>
    <script type="text/javascript">
    $(function() {
  //  	$('.border').css('border', 'solid');
    	
		$.ajax({
			type: "GET",
			url: "header",
			dataType : "html"
		})
		.done(function(data){ 
			$('#headerDiv').html(data);
		})
		.fail(function(XMLHttpRequest, textStatus, errorThrown){
			alert(errorThrown);
		});
		
		var table = null;
		
		function updateVendors() {
			$.ajax({
				type: "GET",
				url: "testerVendors",
				dataType : "json"
			})
			.done(function(data){ 
				$('#testervendor').empty();
				var vendor = null;
				for (let o of data) {
					$('#testervendor').append($('<option>').html(o.vendorname).val(o.id));
					if (vendor == null) {
						vendor = o.id;
					}
				}
				if (table == null) {
					createTable();
				}
			})
			.fail(function(XMLHttpRequest, textStatus, errorThrown){
				alert(errorThrown);
			});					
		};
		
		$('#vendorButton').click(function() {
			$("#vendorDialog").dialog('open');
		});		
		
		updateVendors();
	
		var selectedData;
		
		function createTable() {
			if (table != null) {
				table.destroy();
				$('#table').remove();
			}
			$('#main').append('<table id="testersTable"></table>');
			
			table = $('#testersTable').DataTable({
				"sAjaxSource": 'testerListJson?vendor=' + $('#testervendor').val(),
				"sAjaxDataProp": "",
				"columnDefs": [
				            {
				                "targets": [ 0 ],
				                "visible": false,
				                "searchable": false
				            }
				        ],
				"aoColumns": [
					{ "sTitle": "ID", "mData": "id" },
					{ "sTitle": "Category", "mData": "categoryText" },
					{ "sTitle": "Product Name", "mData": "name" },
					{ "sTitle": "Description", "mData": "description" },
					{ "sTitle": "Type", "mData": "typeText" },
					{ "sTitle": "Edit", "mData": null, "sDefaultContent": '<button class="btn-edit">Edit</button>' },
					{ "sTitle": "Delete", "mData": null, "sDefaultContent": '<button class="btn-delete">Delete</button>' },
				]
			});	
			
			$('#testersTable tbody').on( 'click', 'button', function () {
				var cls = $(this).attr('class');
				selectedData = table.row( $(this).parents('tr') ).data();
				if (cls == 'btn-edit') {
					$('#editTesterName').val(selectedData.name);
					$('#editTesterDescription').val(selectedData.description);
					$('#productTypeList').val(selectedData.type);

					$(".testerCategory").each(function(i,e){
						$('#' + e.id).prop('checked', false);
					});
					for (var c of selectedData.category) {
						$('#categoryCheck' + c).prop('checked', true);
					}

					$("#configDialog").dialog('open');
				}
				else if ('btn-delete') {
				
				}
		    } );
		}
		
		$('#testervendor').change(function() {
			//table.ajax.reload();
			createTable();
			//$('#table').remove();
		});
		
		$("#vendorDialog").dialog({
			modal:true,
			autoOpen: false,
			title: "Vendor Name",
			width: 400,
			height: 200,
			buttons: {
				"OK": function() {
					var obj = new Object();
					obj.vendorname = $('#newTesterVendor').val();
					if (obj.vendorname == '') {
						return;
					}
					var json = JSON.stringify(obj);
					$.ajax({
						type: "POST",
						url: "/testerVendor",
						data: json,
						contentType: "application/json",
						dataType : "json"
					}).done(function(data){
						updateVendors();
					}).fail(function(XMLHttpRequest, status, e){
						alert(e);
					});										
					$(this).dialog("close");
				},
				"Cancel": function() {
					$(this).dialog("close");
				}
			}
		});	
		
		$("#configDialog").dialog({
			modal:true,
			autoOpen: false,
			title: "Config",
			width: 900,
			height: 600,
			buttons: {
				"OK": function() {							
					$(this).dialog("close");
					
					//var obj = new Object();
					//obj.id = selectedData.id;
					selectedData.category = [];
					$(".testerCategory").each(function(i,e){
						if ($('#' + e.id).prop('checked')) {
							selectedData.category.push(e.id.replace('categoryCheck', ''));
						}
					});
					selectedData.name = $('#editTesterName').val();
					selectedData.description = $('#editTesterDescription').val();
					selectedData.type = $('#productTypeList').val();
					
					var json = JSON.stringify(selectedData);
					$.ajax({
						type: "POST",
						url: "/testerJson",
						data: json,
						contentType: "application/json",
						dataType : "text"
					}).done(function(data){
						table.ajax.reload();
					}).fail(function(XMLHttpRequest, status, e){
						alert(e);
					});					
					
					//testerCategory
					
				},
				"Cancel": function() {
					$(this).dialog("close");
				}
			}
		});	

		$("#newTesterDialog").dialog({
			modal:true,
			autoOpen: false,
			title: "New Tester",
			width: 800,
			height: 400,
			buttons: {
				"OK": function() {							
					$(this).dialog("close");
					
					var obj = new Object();
					obj.name = $('#newTesterText').val();
					obj.description = $('#newTesterDescription').val();
					obj.vendorid = $('#testervendor').val();
					obj.type = $('#newTesterProductTypeList').val();
					
					var json = JSON.stringify(obj);
					$.ajax({
						type: "POST",
						url: "/testerJson",
						data: json,
						contentType: "application/json",
						dataType : "text"
					}).done(function(data){
						//createTable();
						table.ajax.reload();
					}).fail(function(XMLHttpRequest, status, e){
						alert(e);
					});										
				},
				"Cancel": function() {
					$(this).dialog("close");
				}
			}
		});	
		$("#categoryEditDialog").dialog({
			modal:true,
			autoOpen: false,
			title: "Category Editor",
			width: 800,
			height: 500,
			buttons: {
				"Close": function() {							
					$(this).dialog("close");
				
					var obj = new Object();
					obj.name = $('#newTesterText').val();
					obj.vendorid = $('#testervendor').val();
					var json = JSON.stringify(obj);

				}
			}
		});		

		$('#addNewTester').click(function(){
			$("#newTesterDialog").dialog('open');
		});
		
		$('#categoryEidtTable').css('width', '100%');
		var categoryTable = $('#categoryEidtTable').DataTable({
			"sAjaxSource": 'TesterCategoryEntityS',
			"sAjaxDataProp": "",
			"columnDefs": [
			            {
			                "targets": [ 0 ],
			                "visible": false,
			                "searchable": false
			            }
			        ],
			"aoColumns": [
				{ "sTitle": "ID", "mData": "id" },
				{ "sTitle": "Category Name", "mData": "category_name" },
				{ "sTitle": "Category Full Name", "mData": "fullname" },
				{ "sTitle": "Edit", "mData": null, "sDefaultContent": '<button class="btn-edit">Edit</button>' },
				{ "sTitle": "Delete", "mData": null, "sDefaultContent": '<button class="btn-delete">Delete</button>' },
			]
		});	
		var selectedCategory;
		$("#categoryElementEditDialog").dialog({
			modal:true,
			autoOpen: false,
			title: "Edit Category Name",
			width: 1000,
			height: 600,
			buttons: {
				"OK": function() {							
					$(this).dialog("close");
				
					var obj = new Object();
					obj.id = selectedCategory.id;
					obj.category_name = $('#categoryNameEdit').val();
					obj.fullname = $('#categoryNameEditFull').val();
					var json = JSON.stringify(obj);
					$.ajax({
						type: "POST",
						url: "/TesterCategoryEntity",
						data: json,
						contentType: "application/json",
						dataType : "json"
					}).done(function(data){
						categoryTable.ajax.reload();
					}).fail(function(XMLHttpRequest, status, e){
						alert(e);
					});	
				},
				"Cancel": function() {
					$(this).dialog("close");
				}
			}
		});			
		
		$('#categoryEidtTable tbody').on( 'click', 'button', function () {
			var cls = $(this).attr('class');
			selectedCategory = categoryTable.row( $(this).parents('tr') ).data();
			if (cls == 'btn-edit') {
				$('#categoryNameEdit').val(selectedCategory.category_name);
				$('#categoryNameEditFull').val(selectedCategory.fullname);
				$("#categoryElementEditDialog").dialog('open');
			}
			else if ('btn-delete') {
			
			}
	    } );
		$('#editCategoryButton').click(function() {
			$("#categoryEditDialog").dialog('open');
		});
		
		$("#newCategoryDialog").dialog({
			modal:true,
			autoOpen: false,
			title: "Category Editor",
			width: 800,
			height: 500,
			buttons: {
				"OK": function() {							
					$(this).dialog("close");
				
					var obj = new Object();
					obj.id = selectedCategory.id;
					obj.category_name = $('#newCategoryText').val();
					obj.fullname = $('#newCategoryFullText').val();
					var json = JSON.stringify(obj);
					$.ajax({
						type: "POST",
						url: "/TesterCategoryEntity",
						data: json,
						contentType: "application/json",
						dataType : "json"
					}).done(function(data){
						categoryTable.ajax.reload();
					}).fail(function(XMLHttpRequest, status, e){
						alert(e);
					});	

				},
				"Cancel": function() {
					$(this).dialog("close");
				}
			}
		});	
		$('#addnewCategory').click(function(){
			$("#newCategoryDialog").dialog('open');
		});
		
		function updateProductList() {
			$.ajax({
				type: "GET",
				url: "/productTypeList",
				dataType : "json"
			})
			.done(function(data){ 
				for (var o of data) {
					$('#productTypeList').append($('<option>').html(o.name).val(o.id));
					$('#newTesterProductTypeList').append($('<option>').html(o.name).val(o.id));
				}
				
			})
			.fail(function(XMLHttpRequest, textStatus, errorThrown){
				alert(errorThrown);
			});				
		}

		updateProductList();
		
		
		$("#parentEditDiv").dialog({
			modal:true,
			autoOpen: false,
			title: "Parent Selector",
			width: 800,
			height: 500,
			buttons: {
				"OK": function() {							
					$(this).dialog("close");
				
					var obj = new Object();
					var json = JSON.stringify(obj);
					$.ajax({
						type: "POST",
						url: "/",
						data: json,
						contentType: "application/json",
						dataType : "json"
					}).done(function(data){
						categoryTable.ajax.reload();
					}).fail(function(XMLHttpRequest, status, e){
						alert(e);
					});	

				},
				"Cancel": function() {
					$(this).dialog("close");
				}
			}
		});	
		
		var parentTable;
		$('#editParents').click(function(){
			$("#parentEditDiv").dialog('open');
			if (parentTable == null) {
				parentTable = $('#parentEditTable').DataTable({
					"sAjaxSource": 'parentTesterJson?vendor=' + $('#testervendor').val(),
					"sAjaxDataProp": "",
					"columnDefs": [
					            {
					                "targets": [ 0 ],
					                "visible": false,
					                "searchable": false
					            }
					        ],
					"aoColumns": [
						{ "sTitle": "ID", "mData": "id" },
						{ "sTitle": "Product Name", "mData": "name" },
						{ "sTitle": "Description", "mData": "description" },
						{ "sTitle": "Check", "mData": "selected" },
//						{ "sTitle": "Select", "mData": null, "sDefaultContent": '<input type="checkbox" class="parent-check">' },
					],
					fnCreatedRow : function(nRow, aData, iDataIndex) {
						// IDに行番号を設定
						// 内部データを加工する場合はここで行う。
						aData.id = iDataIndex;

						// 5列目のtd要素をチェックボックスとして選択
						// （bVisibleをfalseにされた列はnRowには含まれない？）
						var element = $("td:eq(2)", nRow);

						// チェックボックを表示する列のテキストを消去
						element.text("");

						// チェックボックスを生成
						var checkbox = $("<input>")
						.attr("type", "checkbox")

						// idに行番号をつける
						.attr("id", "check" + iDataIndex)

						//classをつける
						.attr("class", "checkbox")

						// check状態を設定
						// aDataにはaoColumnsのmData要素で指定した名前
						.attr("checked", aData.selected)

						// チェックボックスが変更されたときのイベントを登録
						.change(function() {
						// 内部データをチェックされた値に更新
						aData.check = $(this).is(":checked").toString();
						});

						// 要素にチェックボックスを追加
						element.append(checkbox);
						}
				});	
			}
			else {
				parentTable.ajax.reload();
			}
		});
		$('#parentEditSelectAll').click(function(){
			parentTable.rows({"search":"applied" }).every( function () {
			    var data = this.data();
			    data.selected = true;
			});
			
			var newData = parentTable.rows().data();
			parentTable.clear().rows.add(newData).draw(); 
		    parentTable.draw();
    
		});
		$('#parentEditClearAll').click(function(){
			parentTable.rows({"search":"applied" }).every( function () {
			    var data = this.data();
			    data.selected = false;
			});
			
			var newData = parentTable.rows().data();
			parentTable.clear().rows.add(newData).draw(); 
		    parentTable.draw();
    
		});		
		
		
    });
    </script>
</head>
<body>
	<div id='headerDiv'></div>
	<div class="border">Manufacturer<select id='testervendor'></select><button id='vendorButton'>Add Tester Maker</button></div>
	<div id="vendorDialog">
		<input type="text" id="newTesterVendor"></input>	
	</div>
	<div id="configDialog">
		<div>Tester Name:<input type="text" id="editTesterName"></div>
		<div>Description:<input type="text" id="editTesterDescription"></div>
		<div>Product Type<select id="productTypeList"></select><label id="myParentTesters"></label><button id="editParents">Edit Parents</button></div>
		<div class="border">
		<div class="checkbox-inline" th:each="item : ${categoryCheckBox}">
		    <label>
		    	<input type="checkbox" class="testerCategory" name="selectedCategory" th:value="${item.key}" th:text="${item.value}" th:id="'categoryCheck' + ${item.key}"></input>
		    </label>
		</div>
		</div>
	</div>
	
	<button id="addNewTester">Add New Product</button>
	<button id="editCategoryButton">Edit Category</button>
	<div id="newTesterDialog">
		<div>Tester Name<input type="text" id="newTesterText"></input></div>
		<div>Description<input type="text" id="newTesterDescription"></input></div>
		<div>Product Type<select id="newTesterProductTypeList"></select></div>
	</div>
	<div id="categoryEditDialog">
		<button id="addnewCategory">Add Category</button>
		<table id="categoryEidtTable"></table>
		<div id="newCategoryDialog">
			<div>>New Category<input type="text" id="newCategoryText"></div>
			<div>New Category Full Name<input type="text" id="newCategoryFullText"></div>
		</div>
	</div>
	<div id="categoryElementEditDialog">
		<div>Category Name<input type="text" id="categoryNameEdit"></div>
		<div>Full Name<input type="text" id="categoryNameEditFull"></div>
	</div>
	<div id="parentEditDiv">
		<button id="parentEditSelectAll">Select All</button><button id="parentEditClearAll">Clear All</button>
		<table id="parentEditTable"></table>
	</div>
	<div id="main"></div>
</body>
</html>